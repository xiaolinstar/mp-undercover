# 谁是卧底游戏需求文档

## 项目概述

实现一个基于微信公众号的"谁是卧底"游戏服务端，使用 Flask + Redis 技术栈，并通过 Docker Compose 进行部署。这是一个线上线下结合的游戏发牌器，游戏开始后只需要房主最终投票即可。

## 功能需求

### 核心功能

1. **房间管理**
   - 创建房间（房主）
   - 加入房间（通过房间号）
   - 房间状态管理（等待中、游戏中、已结束）

2. **用户管理**
   - 用户身份识别（微信OpenID）
   - 用户昵称设置
   - 房间内用户列表

3. **游戏流程**
   - 最少3人开始游戏
   - 随机分配卧底角色（根据玩家数量可能有多个卧底）
   - 随机分配词语（平民词/卧底词）
   - 游戏开始后仅需房主最终投票决定胜负

### 微信公众号集成

1. **消息处理**
   - 接收用户文本消息
   - 响应游戏指令和操作
   - 推送游戏状态通知

2. **事件处理**
   - 关注事件欢迎消息
   - 菜单点击事件（可选）

## 技术方案

### 后端技术栈

- **Web框架**: Flask
- **数据库**: Redis（存储房间信息、用户状态、游戏数据）
- **WSGI服务器**: Gunicorn
- **反向代理**: Nginx
- **容器化**: Docker + Docker Compose

### 数据结构设计

#### 房间信息 (Room)
```json
{
  "room_id": "1234",
  "status": "waiting|playing|ended",
  "creator": "user_openid",
  "players": ["user_openid1", "user_openid2", "..."],
  "undercovers": ["user_openid1", "user_openid2"], // 可能有多个卧底
  "words": {
    "civilian": "苹果",
    "undercover": "香蕉"
  },
  "current_round": 1,
  "eliminated": ["user_openid"]
}
```

#### 用户信息 (User)
```json
{
  "openid": "user_openid",
  "nickname": "玩家昵称",
  "current_room": "room_id"
}
```

### 卧底分配规则

- 3-5人：1个卧底
- 6-8人：2个卧底
- 9-12人：3个卧底

### API 设计

由于是微信公众号应用，主要通过微信消息接口进行交互：

1. **微信验证接口**: `GET /`
2. **微信消息处理接口**: `POST /`
3. **健康检查接口**: `GET /health`

## 部署方案

### Docker Compose 服务编排

1. **web服务**
   - 基于 Flask 应用构建
   - 使用 Gunicorn 运行
   - 连接 Redis 服务

2. **redis服务**
   - 使用官方 Redis 镜像
   - 持久化数据存储

3. **nginx服务**
   - 反向代理 web 服务
   - 对外暴露 80 端口

### 环境变量配置

- `WECHAT_TOKEN`: 微信公众号Token
- `REDIS_URL`: Redis连接地址
- `SECRET_KEY`: 应用密钥

## 最小化实现方案

### 第一阶段（MVP）

1. 实现基本房间管理功能
2. 实现游戏开始和词语分配（支持多卧底）
3. 实现房主投票决定游戏结果
4. 实现基础的游戏结果判定

### 第二阶段（优化）

1. 增加用户昵称设置
2. 优化游戏流程提示
3. 增加游戏记录统计
4. 实现更完善的错误处理

## 安全考虑

1. 微信消息签名验证
2. 用户身份认证（基于微信OpenID）
3. 防止非法操作

## 性能要求

1. 支持并发多个房间游戏
2. 单个房间支持最多12人
3. 响应时间小于1秒

## 验收标准

1. 能够通过微信公众号正常创建和加入房间
2. 能够正常进行游戏流程
3. 能够正确判断游戏结果
4. 系统稳定，无明显bug